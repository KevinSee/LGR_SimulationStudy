---
title: "LGR Simulation Studies"
author: "Kevin See"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    fig_caption: yes
    fig_height: 8
    fig_width: 8
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    collapsed: yes
    smooth_scroll: yes
  pdf_document:
    fig_caption: yes
    fig_height: 7
    fig_width: 7
csl: /Users/kevin/Documents/Bibliography/StyleFiles/ecology.csl
bibliography:
- /Users/kevin/Documents/Bibliography/Research.bib
- /Users/kevin/Documents/Bibliography/SoftwareCitations.bib
---

```{r intro_prep, message=F, warning=F, results='hide', echo = F}
library(knitr)
library(captioner)
library(pander)
opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
panderOptions('big.mark', ',') # to use , in large numbers in tables
panderOptions('table.split.table', Inf) # so as to not break table onto new lines

tab_nums = captioner(prefix = 'Table')
fig_nums = captioner()

library(lubridate)
library(magrittr)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(jagsUI)

theme_set(theme_bw())
```

```{r load_results, cache = T}
result_nms = list.files('SimulationFits')
result_nms = result_nms[!grepl('other', result_nms)]
scenario_nms = gsub('^Sim_', '', result_nms)
scenario_nms = gsub('\\.rda$', '', scenario_nms)
# length(scenario_nms)
res_list = vector('list', length(scenario_nms))
names(res_list) = scenario_nms

# scenario_nms = c(sort(scenario_nms[grepl('Baseline', scenario_nms)], decreasing = F), sort(scenario_nms[grepl('NightReasc', scenario_nms)], decreasing = F), sort(scenario_nms[grepl('TrapShutdown', scenario_nms)], decreasing = F))

for(i in 1:length(res_list)) {
  load(paste0('SimulationFits/', result_nms[i]))
  res_list[[i]] = res
  rm(res)
}

# pull all results into a data.frame
res_df = ldply(res_list,
               .id = 'Scenario',
               .fun = function(x) {
                 ldply(x,
                       .id = 'sim')
               }) %>% tbl_df() %>%
  mutate(Variable = factor(Variable, levels = c('Unique.Wild.Fish',
                                                'Unique.Hatch.Fish',
                                                'Unique.HNC.Fish',
                                                'All.Fish',
                                                'Daytime.Fish',
                                                'Night.Fish',
                                                'Reascent.Fish'))) %>%
  mutate(Scenario = revalue(Scenario,
                            c('Baseline_WinErr_high' = 'Baseline_Err_H',
                              'Baseline_WinErr_low' = 'Baseline_Err_L',
                              'NightReasc' = 'N-R',
                              'NightReasc_WinErr_high' = 'N-R_Err_H',
                              'NightReasc_WinErr_low' = 'N-R_Err_L',
                              'TrapShutdown' = 'TrapDown',
                              'TrapShutdown_WinErr_high' = 'TrapDown_Err_H',
                              'TrapShutdown_WinErr_low' = 'TrapDown_Err_L',
                              'NightReasc_TrapShutdown' = 'N-R_TrapDown',
                              'NightReasc_TrapShutdown_WinErr_high' = 'N-R_TrapDown_Err_H',
                              'NightReasc_TrapShutdown_WinErr_low' = 'N-R_TrapDown_Err_L')))
rm(res_list)

#------------------------------------------------------
# Re-format res_df into long format of point ests.,
# CI's and CIin for both Models : ISEMP, SCOBI
#------------------------------------------------------
res_long_df <- res_df %>%
  select(Scenario, sim) %>%
  distinct() %>%
  ungroup() %>%
  left_join(res_df) %>%
  mutate(Scenario = factor(Scenario, levels = paste0(rep(c('Baseline', 'TrapDown', 'N-R', 'N-R_TrapDown'), each = 3), c('', '_Err_L', '_Err_H')))) %>%
  gather(key, point, -Scenario, -sim, -Truth, -Variable) %>%
  separate(key, into = c("Model","est"), sep = "_") %>%
  spread(est,point) %>%
  mutate(se = (uppCI - lowCI) / (2 * qnorm(0.975)),
         cv = se / est,
         bias = est - Truth,
         rel_bias = bias / Truth,
         MSE = se^2 + bias^2,
         inCI = ifelse(inCI == 1, T, ifelse(inCI == 0, F, NA)))
```

```{r bias_plots}
abs_bias_p = res_long_df %>%
  ggplot(aes(x = Model,
             fill = Variable,
             y = bias)) +
  geom_boxplot() +
  scale_fill_brewer(palette = 'Set1') +
  geom_hline(yintercept = 0,
             linetype = 2) +
  facet_wrap(~ Scenario, scales = 'free') +
  labs(y = 'Bias') +
  theme(legend.position = 'bottom')

rel_bias_p = res_long_df %>%
  ggplot(aes(x = Model,
             fill = Variable,
             y = rel_bias)) +
  geom_boxplot() +
  scale_fill_brewer(palette = 'Set1') +
  geom_hline(yintercept = 0,
             linetype = 2) +
  facet_wrap(~ Scenario, scales = 'free') +
  labs(y = 'Relative Bias') +
  coord_cartesian(ylim = c(-0.5, 0.5)) +
  theme(legend.position = 'bottom')
```

```{r fig_tab_captions}
abs_bias_fig = fig_nums('abs_bias_fig',
                        'Boxplots showing distrbution of bias across all simulations, for each variable of interest.')

rel_bias_fig = fig_nums('rel_bias_fig',
                        'Boxplots showing distrbution of relative bias (bias / truth) across all simulations, for each variable of interest.')

coverage_tab = tab_nums('coverage_tab',
                        'Proportion of simulations when 95% confidence intervals covered the truth value for the ISEMP and SCOBI models (cov), as well as the median standard error for those estimates (SE). Highlighted cells depict situations where 95% coverage was less than 90%.')

bias_tab = tab_nums('bias_tab',
                    'Displays median bias, relative bias, standard error and root mean squared error (RMSE = sqrt(SE$^2$ + Bias$^2$)).')

```

# Bias Plots

```{r abs_bias_fig, fig.cap = fig_nums('abs_bias_fig')}
print(abs_bias_p)
```

```{r rel_bias_fig, fig.cap= fig_nums('rel_bias_fig')}
print(rel_bias_p)
```

# Tables

`r tab_nums('coverage_tab')`
```{r coverage_tab}
cover_df = res_long_df %>%
  filter(grepl('Unique', Variable)) %>%
  mutate(Variable = revalue(Variable,
                            c('Unique.Wild.Fish' = 'Wild',
                              'Unique.Hatch.Fish' = 'Hatchery',
                              'Unique.HNC.Fish' = 'HNC'))) %>%
  group_by(Scenario, Variable, Model) %>%
  summarise(median_Truth = median(Truth),
            coverage = sum(inCI) / n(),
            SE = median(se)) %>%
  ungroup()

cover_tab = cover_df %>%
  select(-SE) %>%
  spread(Model, coverage) %>%
  rename(ISEMP_cov = ISEMP,
         SCOBI_cov = SCOBI) %>%
  left_join(cover_df %>%
  select(-coverage) %>%
  spread(Model, SE) %>%
  rename(ISEMP_SE = ISEMP,
         SCOBI_SE = SCOBI)) %>%
  select(Scenario:median_Truth, matches('ISEMP'), matches('SCOBI'))

# which have coverage < 90% ?
if(length(which(round(cover_tab$ISEMP_cov, 2) < 0.9)) > 0) {
  cover_mat = data.frame(row = rep(which(round(cover_tab$ISEMP_cov, 2) < 0.9), each = 2),
                         col = grep('ISEMP', names(cover_tab)))
} else {
  cover_mat = data.frame(row = NA,
                         col = which(names(cover_tab) == 'ISEMP_cov'))
}

cover_mat %<>%
  bind_rows(data.frame(row = rep(which(round(cover_tab$SCOBI_cov, 2) < 0.9), each = 2),
                       col = grep('SCOBI', names(cover_tab)))) %>%
  filter(!is.na(row))
cover_mat %<>%
  bind_rows(cover_mat %>%
              mutate(col = 1))


cover_tab %>%
  pander(emphasize.strong.cells = as.matrix(cover_mat))

```

`r tab_nums('bias_tab')`
```{r bias_tab}
bias_tab = res_long_df %>%
  filter(grepl('Unique', Variable)) %>%
  mutate(Variable = revalue(Variable,
                            c('Unique.Wild.Fish' = 'Wild',
                              'Unique.Hatch.Fish' = 'Hatchery',
                              'Unique.HNC.Fish' = 'HNC'))) %>%
  group_by(Scenario, Variable, Model) %>%
  summarise(Avg_Truth = round(median(Truth)),
            Bias = median(bias),
            Rel_Bias = median(rel_bias),
            SE = median(se),
            RMSE = sqrt(SE^2 + Bias^2))

bias_tab %>%
  pander()
  # pander(emphasize.strong.rows = with(bias_tab, which(abs(RMSE - SE) > 10)))
```


# Coverage Plots

```{r coverage_fig}
samp_sims = sample(unique(res_df$sim), 25)

pd = .4

res_long_df %>%
  filter(sim %in% samp_sims) %>%
  filter(grepl('^Unique', Variable)) %>%
  mutate(Variable = revalue(Variable,
                            c('Unique.Wild.Fish' = 'Wild',
                              'Unique.Hatch.Fish' = 'Hatchery',
                              'Unique.HNC.Fish' = 'HNC'))) %>%
  mutate(low_bias = lowCI - Truth,
         upp_bias = uppCI - Truth) %>%
  ggplot(aes(y = sim,
             x = bias,
             color = Model,
             shape = inCI)) +
  scale_shape_manual(values = c('TRUE' = 19,
                                'FALSE' = 1)) +
  geom_errorbarh(aes(xmin = low_bias,
                     xmax = upp_bias),
                 position = position_dodge(width = pd)) +
  geom_point(position = position_dodge(width = pd)) +
  geom_vline(xintercept = 0,
             linetype = 2) +
  facet_grid(Scenario ~ Variable, scales = 'free_x') +
  scale_color_brewer(palette = 'Set1') +
  theme(axis.text.y = element_blank()) +
  labs(y = 'Simulation',
       x = 'Bias',
       shape = 'In Conf. Int.',
       title = paste('Sample of', length(samp_sims), 'Simulations'))
```

# Night Passage $!=$ Reascension

The SCOBI model exhibits some bias when re-ascension and night-time passage rates are not equal. By adding the the total estimates for wild, hatchery and HNC fish, we can calculated an overall realized bias by substracting that from the underlying true number of individual fish that crossed LGR in the simulation. We can also calculate the true number of re-ascending fish and subtract the true number of fish that crossed during the night. This difference explains the bias in the SCOBI estimates very well.

```{r night_reasc_bias}
bias_df = res_df %>%
  filter(Scenario == 'N-R',
         Variable %in% c('Night.Fish', 'Reascent.Fish')) %>%
  select(Scenario, sim, Variable, Truth) %>%
  spread(Variable, Truth) %>%
  mutate(pot_bias = Reascent.Fish - Night.Fish) %>%
  left_join(res_df %>%
              filter(Scenario == 'N-R',
                     grepl('Unique', Variable)) %>%
              group_by(Scenario, sim) %>%
              summarise(Uni.Fish.Truth = sum(Truth),
                        Tot.Fish.SCOBI = sum(SCOBI_est)) %>%
              mutate(bias = Tot.Fish.SCOBI - Uni.Fish.Truth))

mod = lm(bias ~ pot_bias, data = bias_df)

bias_p = ggplot(aes(pot_bias, 
                    bias), 
                data = bias_df) +
  geom_point() +
  geom_abline(color = 'red',
              linetype = 2) +
  geom_smooth(method = lm) +
    labs(x = 'Reascent - Night',
       y = 'Total Bias') +
  geom_text(data = data.frame(Coef = coef(mod)),
            aes(x = -Inf, 
                y = Inf,
                label = paste0('y = ', round(Coef[1], 2), ' + ', round(Coef[2], 2), 'x')),
            hjust = -0.5,
            vjust = 3)

print(bias_p)
```
